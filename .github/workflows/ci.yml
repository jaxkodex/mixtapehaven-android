name: Android CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle packages
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Lint
        run: ./gradlew lint

      - name: Run Unit Tests
        run: ./gradlew test

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-results
          path: app/build/reports/lint-results-*.html

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: app/build/reports/tests/

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: apk-debug-${{ github.event.pull_request.number || github.sha }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Comment PR with APK download link
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const commitSha = context.sha.substring(0, 7);
            const branchName = context.payload.pull_request.head.ref;
            const runId = context.runId;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            const artifactName = `apk-debug-${prNumber}`;
            const artifactUrl = `https://github.com/${repoOwner}/${repoName}/actions/runs/${runId}`;
            
            const commentBody = `## ðŸ“± APK Ready for Testing

**Build Details:**
- PR: #${prNumber}
- Commit: \`${commitSha}\`
- Branch: \`${branchName}\`

**Download:**
1. Go to the [workflow run page](${artifactUrl})
2. Scroll down to the **Artifacts** section
3. Download the \`apk-debug-${prNumber}\` artifact
4. Extract the ZIP file to get the APK

**Installation:**
1. Download and extract the APK file
2. Enable "Install from unknown sources" on your Android device
3. Open the APK file to install

---

*This comment was automatically generated by GitHub Actions*`;

            // Find existing comment to update or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: repoOwner,
              repo: repoName,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('APK Ready for Testing')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: repoOwner,
                repo: repoName,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: prNumber,
                body: commentBody,
              });
            }
